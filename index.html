<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title></title>
    <link rel="icon" href="https://files.catbox.moe/wcygxg.png" type="image/png">
    <style>
        :root {
            --gap: 10px;
            --bg: #f0f0f0;
            --border: #ddd;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: system-ui, Arial, sans-serif;
            background: var(--bg);
        }

        #mediaGrid {
            display: flex;
            flex-wrap: wrap;
            padding: 20px;
            gap: var(--gap);
            box-sizing: border-box;
        }

        .media-item {
            width: calc(25% - var(--gap));
            border: 1px solid var(--border);
            background: #f0f0f0;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
            border-radius: 4px;
            transition: transform 0.2s, box-shadow 0.2s;
            box-sizing: border-box;
        }

        .media-item:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .media-item video,
        .media-item img {
            width: 100%;
            height: auto;
            display: block;
            cursor: pointer;
        }

        .info {
            display: none;
        }

        /* Responsive layout */
        @media (max-width: 768px) {
            .media-item {
                width: calc(50% - var(--gap));
            }
        }

        @media (max-width: 480px) {
            .media-item {
                width: 100%;
            }
        }

        /* Fullscreen container */
        #fullscreenContainer {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.85);
            justify-content: center;
            align-items: center;
            z-index: 1000;
            cursor: pointer;
        }

        #fullscreenImage {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
            outline: none;
            pointer-events: none; /* Prevent clicks on the image itself */
        }

        /* Loading placeholder */
        .media-item .thumbnail {
            width: 100%;
            height: auto;
            display: block;
            cursor: pointer;
            filter: blur(5px);
            transition: filter 0.3s;
        }

        .media-item .thumbnail.loaded {
            filter: blur(0);
        }
    </style>
</head>
<body>
    <main id="mediaGrid"></main>

    <!-- Fullscreen image overlay -->
    <div id="fullscreenContainer" role="dialog" aria-modal="true" tabindex="-1">
        <img id="fullscreenImage" src="" alt="Fullscreen Image">
    </div>

    <script>
        // Service Worker (unchanged, but consider improvements)
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('service-worker.js')
                .then(registration => {
                    console.log('Service Worker registered with scope:', registration.scope);
                })
                .catch(error => {
                    console.error('Service Worker registration failed:', error);
                });
        }

        document.addEventListener('DOMContentLoaded', () => {
            const STORAGE_KEY = 'directMediaList';
            const DEFAULT_LIST = [{
                    url: 'https://files.catbox.moe/6figov.mp4',
                    type: 'video',
                    poster: 'https://files.catbox.moe/lq7ut6.jpg',
                    thumbnail: 'https://files.catbox.moe/lq7ut6.jpg'
                }
            ];

            const mediaList = JSON.parse(localStorage.getItem(STORAGE_KEY)) || DEFAULT_LIST;
            const grid = document.getElementById('mediaGrid');
            const fullscreenContainer = document.getElementById('fullscreenContainer');
            const fullscreenImage = document.getElementById('fullscreenImage');
            const allVideos = [];
            const blobUrls = [];
            let currentVideoBlobUrl = null;

            // Helper function to convert URL to Blob (for potential future use)
            async function urlToBlob(url) {
                const resp = await fetch(url);
                if (!resp.ok) throw new Error(`HTTP ${resp.status} ${url}`);
                return await resp.blob();
            }

            function stopAllExcept(current) {
                allVideos.forEach(v => {
                    if (v !== current) {
                        v.pause();
                    }
                });
            }

            function showImage(src, alt = '') {
                fullscreenImage.src = src;
                fullscreenImage.alt = alt;
                fullscreenContainer.style.display = 'flex';
                fullscreenImage.focus();
            }

            function hideImage() {
                fullscreenContainer.style.display = 'none';
                fullscreenImage.src = '';
                fullscreenImage.alt = '';
            }

            function bindKeyboardForVideo(video) {
                video.addEventListener('keydown', e => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        video.paused ? video.play() : video.pause();
                    }
                    if (e.key === 'f') {
                        e.preventDefault();
                        if (document.fullscreenElement) {
                            document.exitFullscreen().catch(() => {});
                        } else {
                            video.requestFullscreen().catch(() => {});
                        }
                    }
                });
            }

            function bindKeyboardForImg(img) {
                img.addEventListener('keydown', e => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        showImage(img.src, img.alt);
                    }
                });
            }

            const observer = new IntersectionObserver((entries, obs) => {
                entries.forEach(entry => {
                    if (!entry.isIntersecting) return;
                    const wrapper = entry.target;
                    const {
                        type,
                        url,
                        poster,
                        alt,
                        thumbnail
                    } = wrapper.dataset;

                    if (type === 'video') {
                        loadVideo(wrapper, url, poster || '', thumbnail || '');
                    } else {
                        loadImage(wrapper, url, alt || '', thumbnail || '');
                    }
                    obs.unobserve(wrapper);
                });
            }, {
                rootMargin: '200px' // Preload a bit before it's visible
            });

            function renderGrid() {
                grid.innerHTML = '';
                allVideos.length = 0; // Clear the array
                mediaList.forEach((item, idx) => {
                    const wrapper = document.createElement('div');
                    wrapper.className = 'media-item';
                    wrapper.dataset.idx = idx;
                    wrapper.dataset.type = item.type;
                    wrapper.dataset.url = item.url;
                    if (item.poster) wrapper.dataset.poster = item.poster;
                    if (item.alt) wrapper.dataset.alt = item.alt;
                    if (item.thumbnail) wrapper.dataset.thumbnail = item.thumbnail;

                    // Thumbnail Image
                    const thumbnailImg = document.createElement('img');
                    thumbnailImg.className = 'thumbnail';
                    thumbnailImg.src = item.thumbnail;
                    thumbnailImg.alt = item.alt || 'Thumbnail';

                    // Add a class when the thumbnail is loaded
                    thumbnailImg.onload = () => {
                        thumbnailImg.classList.add('loaded');
                    };
                    thumbnailImg.onerror = () => {
                        console.error("Failed to load thumbnail:", item.thumbnail);
                    };

                    wrapper.appendChild(thumbnailImg);
                    grid.appendChild(wrapper);
                    observer.observe(wrapper);
                });
            }

            async function loadVideo(container, url, poster, thumbnail) {
                const video = document.createElement('video');
                video.controls = false; // Custom controls
                video.poster = poster;
                video.preload = 'metadata';
                video.volume = 0.3;
                video.tabIndex = 0; // Make it focusable

                let clickTimer = null;

                video.addEventListener('click', () => {
                    if (clickTimer) clearTimeout(clickTimer);
                    clickTimer = setTimeout(() => {
                        video.paused ? video.play() : video.pause();
                        clickTimer = null;
                    }, 250);
                });

                video.addEventListener('dblclick', () => {
                    if (clickTimer) {
                        clearTimeout(clickTimer);
                        clickTimer = null;
                    }
                    if (document.fullscreenElement) {
                        document.exitFullscreen().catch(() => {});
                    } else {
                        video.requestFullscreen().catch(() => {});
                    }
                });

                video.addEventListener('fullscreenchange', () => {
                    video.controls = !!document.fullscreenElement;
                });

                video.addEventListener('play', () => stopAllExcept(video));
                video.addEventListener('ended', () => {
                    video.currentTime = 0;
                    video.play(); // Loop the video
                });

                bindKeyboardForVideo(video);

                try {
                    if (currentVideoBlobUrl) {
                        URL.revokeObjectURL(currentVideoBlobUrl);
                    }
                    const blob = await urlToBlob(url);
                    const blobUrl = URL.createObjectURL(blob);
                    video.src = blobUrl;
                    currentVideoBlobUrl = blobUrl;
                    blobUrls.push(blobUrl);
                    container.querySelector('.thumbnail').classList.add('loaded');
                } catch (e) {
                    console.error('Fetch video failed, fallback to direct URL', e);
                    video.src = url;
                }
                container.innerHTML = '';
                container.appendChild(video);
                allVideos.push(video);
            }

            async function loadImage(container, url, alt = '', thumbnail) {
                const img = document.createElement('img');
                img.alt = alt || 'Image';
                img.tabIndex = 0; // Make it focusable

                img.addEventListener('dblclick', e => {
                    e.preventDefault();
                    showImage(img.src, img.alt);
                });

                bindKeyboardForImg(img);

                try {
                    const blob = await urlToBlob(url);
                    const blobUrl = URL.createObjectURL(blob);
                    img.src = blobUrl;
                    blobUrls.push(blobUrl);
                    container.querySelector('.thumbnail').classList.add('loaded');
                } catch (e) {
                    console.error('Fetch image failed, fallback to direct URL', e);
                    img.src = url;
                }
                container.innerHTML = '';
                container.appendChild(img);
            }

            fullscreenContainer.addEventListener('click', hideImage);
            fullscreenContainer.addEventListener('keydown', e => {
                if (e.key === 'Escape') hideImage();
            });

            window.addEventListener('beforeunload', () => {
                blobUrls.forEach(url => URL.revokeObjectURL(url));
            });

            renderGrid();
        });
    </script>
</body>
</html>



